"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";
import Link from "next/link";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Switch } from "@/components/ui/switch";
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Badge } from "@/components/ui/badge";
import { useToast } from "@/components/ui/use-toast";
import {
  ArrowLeft,
  Bot,
  Mic,
  Phone,
  ShieldAlert,
  BookOpen,
  Settings,
  Loader2,
  Plus,
  Trash2,
} from "lucide-react";
import { getIndustryTemplates, DEFAULT_RECORDING_DISCLOSURE } from "@/lib/templates";
import { PromptBuilder } from "@/components/prompt-builder";
import type { PromptConfig } from "@/lib/prompt-builder/types";

// Voice options
const VOICE_OPTIONS = [
  { value: "rachel", label: "Rachel (Female)", provider: "11labs" },
  { value: "drew", label: "Drew (Male)", provider: "11labs" },
  { value: "clyde", label: "Clyde (Male)", provider: "11labs" },
  { value: "paul", label: "Paul (Male)", provider: "11labs" },
  { value: "domi", label: "Domi (Female)", provider: "11labs" },
  { value: "dave", label: "Dave (Male)", provider: "11labs" },
  { value: "fin", label: "Fin (Male)", provider: "11labs" },
  { value: "sarah", label: "Sarah (Female)", provider: "11labs" },
];

// Model options
const MODEL_OPTIONS = [
  { value: "gpt-4o-mini", label: "GPT-4o Mini (Recommended)", provider: "openai" },
  { value: "gpt-4o", label: "GPT-4o", provider: "openai" },
  { value: "gpt-4-turbo", label: "GPT-4 Turbo", provider: "openai" },
];

// Industry templates
const INDUSTRY_TEMPLATES = getIndustryTemplates();

interface Assistant {
  id: string;
  name: string;
  system_prompt: string;
  first_message: string;
  voice_id: string;
  voice_provider: string;
  model: string;
  model_provider: string;
  is_active: boolean;
  settings: Record<string, any>;
  prompt_config: Record<string, any> | null;
  vapi_assistant_id: string | null;
  phone_numbers?: { id: string; phone_number: string }[];
  organization_id?: string;
}

interface TransferRule {
  id: string;
  name: string;
  trigger_keywords: string[];
  trigger_intent: string | null;
  transfer_to_phone: string;
  transfer_to_name: string | null;
  announcement_message: string | null;
  priority: number;
  is_active: boolean;
}

interface AssistantBuilderProps {
  assistant: Assistant;
  organizationId: string;
  transferRules: TransferRule[];
}

export function AssistantBuilder({
  assistant,
  organizationId,
  transferRules: initialTransferRules,
}: AssistantBuilderProps) {
  const router = useRouter();
  const { toast } = useToast();

  // Basic info state
  const [name, setName] = useState(assistant.name);
  const [systemPrompt, setSystemPrompt] = useState(assistant.system_prompt);
  const [firstMessage, setFirstMessage] = useState(assistant.first_message);
  const [voiceId, setVoiceId] = useState(assistant.voice_id);
  const [model, setModel] = useState(assistant.model);
  const [isActive, setIsActive] = useState(assistant.is_active);

  // Settings state
  const [maxCallDuration, setMaxCallDuration] = useState(
    assistant.settings?.maxCallDuration || 600
  );
  const [spamFilterEnabled, setSpamFilterEnabled] = useState(
    assistant.settings?.spamFilterEnabled ?? true
  );
  const [recordingEnabled, setRecordingEnabled] = useState(
    assistant.settings?.recordingEnabled ?? true
  );
  const [recordingDisclosure, setRecordingDisclosure] = useState(
    assistant.settings?.recordingDisclosure ?? DEFAULT_RECORDING_DISCLOSURE
  );

  // Transfer rules state
  const [transferRules, setTransferRules] = useState(initialTransferRules);
  const [transferEnabled, setTransferEnabled] = useState(transferRules.length > 0);
  const [newTransferPhone, setNewTransferPhone] = useState("");
  const [newTransferName, setNewTransferName] = useState("");

  // Prompt builder state
  const [promptConfig, setPromptConfig] = useState<PromptConfig | null>(
    (assistant.prompt_config as PromptConfig) || null
  );
  const [useGuidedBuilder, setUseGuidedBuilder] = useState(
    assistant.prompt_config !== null
  );

  // Saving state
  const [isSaving, setIsSaving] = useState(false);

  // Apply industry template
  const applyTemplate = (industryKey: string) => {
    const template = INDUSTRY_TEMPLATES.find((t) => t.industry === industryKey);
    if (template) {
      setSystemPrompt(template.systemPrompt);
      setFirstMessage(template.firstMessage);
      if (template.voiceId) {
        setVoiceId(template.voiceId);
      }
      toast({
        title: "Template Applied",
        description: `Applied ${template.name} template. You can customize it further.`,
      });
    }
  };

  // Save assistant
  const handleSave = async () => {
    setIsSaving(true);
    try {
      const response = await fetch(`/api/v1/assistants/${assistant.id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          name,
          systemPrompt,
          firstMessage,
          voiceId,
          model,
          isActive,
          settings: {
            ...assistant.settings,
            maxCallDuration,
            spamFilterEnabled,
            recordingEnabled,
            recordingDisclosure,
          },
          promptConfig: useGuidedBuilder ? promptConfig : null,
        }),
      });

      if (!response.ok) {
        const errorBody = await response.json().catch(() => null);
        throw new Error(errorBody?.error || "Failed to save assistant");
      }

      toast({
        title: "Saved",
        description: "Assistant settings have been updated.",
      });

      router.refresh();
    } catch (error) {
      toast({
        variant: "destructive",
        title: "Error",
        description: error instanceof Error ? error.message : "Failed to save assistant settings.",
      });
    } finally {
      setIsSaving(false);
    }
  };

  // Add transfer rule
  const addTransferRule = async () => {
    if (!newTransferPhone) {
      toast({
        variant: "destructive",
        title: "Error",
        description: "Please enter a phone number for transfers.",
      });
      return;
    }

    try {
      const response = await fetch("/api/v1/transfer/rules", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          assistantId: assistant.id,
          name: newTransferName || "Default Transfer",
          transferToPhone: newTransferPhone,
          transferToName: newTransferName || null,
          triggerKeywords: ["speak to a human", "talk to someone", "representative"],
        }),
      });

      if (!response.ok) {
        throw new Error("Failed to create transfer rule");
      }

      const { rule } = await response.json();
      setTransferRules([...transferRules, rule]);
      setNewTransferPhone("");
      setNewTransferName("");

      toast({
        title: "Transfer Rule Added",
        description: "Callers can now be transferred to this number.",
      });
    } catch {
      toast({
        variant: "destructive",
        title: "Error",
        description: "Failed to add transfer rule.",
      });
    }
  };

  // Delete transfer rule
  const deleteTransferRule = async (ruleId: string) => {
    try {
      const response = await fetch(`/api/v1/transfer/rules/${ruleId}`, {
        method: "DELETE",
      });

      if (!response.ok) {
        throw new Error("Failed to delete transfer rule");
      }

      setTransferRules(transferRules.filter((r) => r.id !== ruleId));

      toast({
        title: "Transfer Rule Deleted",
      });
    } catch {
      toast({
        variant: "destructive",
        title: "Error",
        description: "Failed to delete transfer rule.",
      });
    }
  };

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-4">
          <Link href="/assistants">
            <Button variant="ghost" size="icon">
              <ArrowLeft className="h-4 w-4" />
            </Button>
          </Link>
          <div>
            <div className="flex items-center gap-2">
              <h1 className="text-2xl font-bold">{assistant.name}</h1>
              <Badge variant={isActive ? "success" : "secondary"}>
                {isActive ? "Active" : "Inactive"}
              </Badge>
            </div>
            {assistant.phone_numbers && assistant.phone_numbers.length > 0 && (
              <p className="text-sm text-muted-foreground">
                {assistant.phone_numbers.map((p) => p.phone_number).join(", ")}
              </p>
            )}
          </div>
        </div>
        <Button onClick={handleSave} disabled={isSaving}>
          {isSaving ? (
            <>
              <Loader2 className="h-4 w-4 mr-2 animate-spin" />
              Saving...
            </>
          ) : (
            "Save Changes"
          )}
        </Button>
      </div>

      {/* Tabs */}
      <Tabs defaultValue="basics" className="space-y-6">
        <TabsList className="grid w-full grid-cols-4">
          <TabsTrigger value="basics" className="flex items-center gap-2">
            <Bot className="h-4 w-4" />
            Basics
          </TabsTrigger>
          <TabsTrigger value="voice" className="flex items-center gap-2">
            <Mic className="h-4 w-4" />
            Voice
          </TabsTrigger>
          <TabsTrigger value="transfers" className="flex items-center gap-2">
            <Phone className="h-4 w-4" />
            Transfers
          </TabsTrigger>
          <TabsTrigger value="settings" className="flex items-center gap-2">
            <Settings className="h-4 w-4" />
            Settings
          </TabsTrigger>
        </TabsList>

        {/* Basics Tab */}
        <TabsContent value="basics" className="space-y-6">
          <Card>
            <CardHeader>
              <CardTitle>Basic Information</CardTitle>
              <CardDescription>
                Configure your assistant's name and how it introduces itself
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="space-y-2">
                <Label htmlFor="name">Assistant Name</Label>
                <Input
                  id="name"
                  value={name}
                  onChange={(e) => setName(e.target.value)}
                  placeholder="e.g., Sarah - Front Desk"
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="firstMessage">Greeting Message</Label>
                <Textarea
                  id="firstMessage"
                  value={firstMessage}
                  onChange={(e) => setFirstMessage(e.target.value)}
                  rows={2}
                  placeholder="What should the assistant say when answering?"
                />
                <p className="text-xs text-muted-foreground">
                  This is the first thing callers will hear
                </p>
              </div>

              <div className="flex items-center justify-between">
                <div>
                  <Label>Active Status</Label>
                  <p className="text-xs text-muted-foreground">
                    When inactive, calls will go to voicemail
                  </p>
                </div>
                <Switch checked={isActive} onCheckedChange={setIsActive} />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardHeader>
              <CardTitle>Instructions (System Prompt)</CardTitle>
              <CardDescription>
                Tell your AI how to behave and what information to provide
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              {useGuidedBuilder ? (
                <PromptBuilder
                  config={promptConfig}
                  industry="other"
                  businessName={name}
                  systemPrompt={systemPrompt}
                  firstMessage={firstMessage}
                  onChange={(updates) => {
                    setSystemPrompt(updates.systemPrompt);
                    setFirstMessage(updates.firstMessage);
                    setPromptConfig(updates.promptConfig);
                  }}
                  variant="dashboard"
                />
              ) : (
                <>
                  <div className="rounded-lg border border-blue-200 bg-blue-50 dark:border-blue-900 dark:bg-blue-950/50 p-4">
                    <div className="flex items-start justify-between gap-4">
                      <div>
                        <p className="text-sm font-medium text-blue-900 dark:text-blue-100">
                          Try the Guided Prompt Builder
                        </p>
                        <p className="text-xs text-blue-700 dark:text-blue-300 mt-0.5">
                          Configure your assistant visually â€” pick fields, toggle behaviors, and choose a tone without writing prompts.
                        </p>
                      </div>
                      <Button
                        variant="outline"
                        size="sm"
                        className="shrink-0"
                        onClick={() => {
                          setUseGuidedBuilder(true);
                          // Keep existing prompt in advanced editor
                        }}
                      >
                        Switch to Guided
                      </Button>
                    </div>
                  </div>

                  <div className="flex gap-2">
                    <Select onValueChange={applyTemplate}>
                      <SelectTrigger className="w-[200px]">
                        <SelectValue placeholder="Apply Template" />
                      </SelectTrigger>
                      <SelectContent>
                        {INDUSTRY_TEMPLATES.map((template) => (
                          <SelectItem key={template.industry} value={template.industry}>
                            {template.name}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                    <p className="text-sm text-muted-foreground self-center">
                      Start with an industry template and customize
                    </p>
                  </div>

                  <Textarea
                    value={systemPrompt}
                    onChange={(e) => setSystemPrompt(e.target.value)}
                    rows={15}
                    placeholder="Describe how the assistant should behave..."
                    className="font-mono text-sm"
                  />
                </>
              )}
            </CardContent>
          </Card>
        </TabsContent>

        {/* Voice Tab */}
        <TabsContent value="voice" className="space-y-6">
          <Card>
            <CardHeader>
              <CardTitle>Voice Settings</CardTitle>
              <CardDescription>
                Choose the voice and AI model for your assistant
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="grid gap-4 md:grid-cols-2">
                <div className="space-y-2">
                  <Label>Voice</Label>
                  <Select value={voiceId} onValueChange={setVoiceId}>
                    <SelectTrigger>
                      <SelectValue placeholder="Select a voice" />
                    </SelectTrigger>
                    <SelectContent>
                      {VOICE_OPTIONS.map((voice) => (
                        <SelectItem key={voice.value} value={voice.value}>
                          {voice.label}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label>AI Model</Label>
                  <Select value={model} onValueChange={setModel}>
                    <SelectTrigger>
                      <SelectValue placeholder="Select a model" />
                    </SelectTrigger>
                    <SelectContent>
                      {MODEL_OPTIONS.map((m) => (
                        <SelectItem key={m.value} value={m.value}>
                          {m.label}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>
              </div>
            </CardContent>
          </Card>
        </TabsContent>

        {/* Transfers Tab */}
        <TabsContent value="transfers" className="space-y-6">
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Phone className="h-5 w-5" />
                Call Transfers
              </CardTitle>
              <CardDescription>
                Configure when and where calls should be transferred to a human
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="flex items-center justify-between">
                <div>
                  <Label>Enable Call Transfers</Label>
                  <p className="text-xs text-muted-foreground">
                    Allow callers to be transferred to a human when needed
                  </p>
                </div>
                <Switch
                  checked={transferEnabled}
                  onCheckedChange={setTransferEnabled}
                />
              </div>

              {transferEnabled && (
                <>
                  <div className="border-t pt-4">
                    <Label className="mb-2 block">Add Transfer Destination</Label>
                    <div className="flex gap-2">
                      <Input
                        placeholder="Phone number"
                        value={newTransferPhone}
                        onChange={(e) => setNewTransferPhone(e.target.value)}
                        className="flex-1"
                      />
                      <Input
                        placeholder="Name (optional)"
                        value={newTransferName}
                        onChange={(e) => setNewTransferName(e.target.value)}
                        className="flex-1"
                      />
                      <Button onClick={addTransferRule}>
                        <Plus className="h-4 w-4" />
                      </Button>
                    </div>
                  </div>

                  {transferRules.length > 0 && (
                    <div className="space-y-2">
                      {transferRules.map((rule) => (
                        <div
                          key={rule.id}
                          className="flex items-center justify-between p-3 border rounded-lg"
                        >
                          <div>
                            <p className="font-medium">
                              {rule.transfer_to_name || rule.transfer_to_phone}
                            </p>
                            <p className="text-sm text-muted-foreground">
                              {rule.transfer_to_phone}
                            </p>
                          </div>
                          <Button
                            variant="ghost"
                            size="icon"
                            onClick={() => deleteTransferRule(rule.id)}
                          >
                            <Trash2 className="h-4 w-4 text-destructive" />
                          </Button>
                        </div>
                      ))}
                    </div>
                  )}
                </>
              )}
            </CardContent>
          </Card>
        </TabsContent>

        {/* Settings Tab */}
        <TabsContent value="settings" className="space-y-6">
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Settings className="h-5 w-5" />
                Call Settings
              </CardTitle>
              <CardDescription>
                Configure call handling behavior
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="space-y-2">
                <Label>Maximum Call Duration (seconds)</Label>
                <Input
                  type="number"
                  value={maxCallDuration}
                  onChange={(e) => setMaxCallDuration(parseInt(e.target.value) || 600)}
                  min={60}
                  max={3600}
                />
                <p className="text-xs text-muted-foreground">
                  Calls will automatically end after this duration (default: 10 minutes)
                </p>
              </div>

              <div className="flex items-center justify-between">
                <div>
                  <Label className="flex items-center gap-2">
                    <ShieldAlert className="h-4 w-4" />
                    Spam Call Filtering
                  </Label>
                  <p className="text-xs text-muted-foreground">
                    Automatically detect and filter spam calls
                  </p>
                </div>
                <Switch
                  checked={spamFilterEnabled}
                  onCheckedChange={setSpamFilterEnabled}
                />
              </div>

              <div className="border-t pt-4 space-y-4">
                <div className="flex items-center justify-between">
                  <div>
                    <Label>Call Recording</Label>
                    <p className="text-xs text-muted-foreground">
                      Record calls for quality assurance. A disclosure will be
                      played at the start of each call.
                    </p>
                  </div>
                  <Switch
                    checked={recordingEnabled}
                    onCheckedChange={setRecordingEnabled}
                  />
                </div>

                {recordingEnabled && (
                  <div className="space-y-2">
                    <Label htmlFor="recordingDisclosure">
                      Recording & AI Disclosure
                    </Label>
                    <Textarea
                      id="recordingDisclosure"
                      value={recordingDisclosure}
                      onChange={(e) => setRecordingDisclosure(e.target.value)}
                      rows={4}
                      placeholder="Disclosure message played before the greeting..."
                    />
                    <p className="text-xs text-muted-foreground">
                      This message is spoken before your greeting. Use{" "}
                      <code className="bg-muted px-1 rounded">
                        {"{business_name}"}
                      </code>{" "}
                      to insert your business name. Callers who decline
                      recording will be offered a transfer to a team member.
                    </p>
                  </div>
                )}
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <BookOpen className="h-5 w-5" />
                Knowledge Base
              </CardTitle>
              <CardDescription>
                Manage the business information your AI uses to answer questions
              </CardDescription>
            </CardHeader>
            <CardContent>
              <Link href="/settings/knowledge">
                <Button variant="outline">Manage Knowledge Sources</Button>
              </Link>
            </CardContent>
          </Card>

          <Card>
            <CardHeader>
              <CardTitle>Technical Details</CardTitle>
            </CardHeader>
            <CardContent className="space-y-2 text-sm">
              <div className="flex justify-between">
                <span className="text-muted-foreground">Assistant ID</span>
                <code className="bg-muted px-2 py-1 rounded">{assistant.id}</code>
              </div>
              {assistant.vapi_assistant_id && (
                <div className="flex justify-between">
                  <span className="text-muted-foreground">Vapi ID</span>
                  <code className="bg-muted px-2 py-1 rounded">
                    {assistant.vapi_assistant_id}
                  </code>
                </div>
              )}
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>
    </div>
  );
}
